---
/**
 * 超声图展示页面
 */
import Layout from '@/layouts/Layout.astro';
import { Header } from '@/components/layout/Header';
---

<Layout 
  title="超声图像展示 - A/B/C/S扫描可视化 | 超声数据管理系统"
  description="专业的超声图像展示系统，支持A扫描（时间-幅度曲线）、B扫描（深度-位置截面图）、C扫描（平面投影图）、S扫描（扇形扫描图）多种显示模式。提供交互式图像操作、伪彩色映射、缺陷标注测量等功能。"
  keywords="超声图像,A扫描,B扫描,C扫描,S扫描,相控阵,图像可视化,缺陷检测,伪彩色映射"
>
  <Header currentPath="/ultrasonic" client:load />
  
  <main class="min-h-screen bg-primary-900 py-8">
    <div class="container mx-auto px-4">
      <!--Page Header -->
      <div class="mb-8">
        <h1 class="text-3xl font-bold text-white mb-2">超声图像展示</h1>
        <p class="text-gray-400">A/B/C/S扫描多种模式，专业超声图像可视化</p>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
        <!-- Control Panel -->
        <div class="lg:col-span-1">
          <div class="card sticky top-24">
            <h3 class="text-lg font-bold text-white mb-4">控制面板</h3>
            
            <!-- View Type -->
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-300 mb-2">显示模式</label>
              <select id="viewType" class="input">
                <option value="A-Scan">A扫描 (A-Scan)</option>
                <option value="B-Scan" selected>B扫描 (B-Scan)</option>
                <option value="C-Scan">C扫描 (C-Scan)</option>
                <option value="S-Scan">S扫描 (S-Scan)</option>
              </select>
            </div>

            <!-- Color Map -->
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-300 mb-2">颜色映射</label>
              <select id="colorMap" class="input">
                <option value="gray" selected>灰度</option>
                <option value="jet">Jet</option>
                <option value="hot">热力图</option>
                <option value="cool">冷色</option>
                <option value="rainbow">彩虹</option>
              </select>
            </div>

            <!-- Contrast -->
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-300 mb-2">
                对比度: <span id="contrastValue">50</span>
              </label>
              <input type="range" id="contrast" min="0" max="100" value="50" class="w-full" />
            </div>

            <!-- Brightness -->
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-300 mb-2">
                亮度: <span id="brightnessValue">50</span>
              </label>
              <input type="range" id="brightness" min="0" max="100" value="50" class="w-full" />
            </div>

            <!-- Threshold -->
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-300 mb-2">
                阈值: <span id="thresholdValue">100</span>
              </label>
              <input type="range" id="threshold" min="0" max="255" value="100" class="w-full" />
            </div>

            <!-- Options -->
            <div class="space-y-2 mb-4">
              <label class="flex items-center">
                <input type="checkbox" id="showGrid" class="rounded mr-2" />
                <span class="text-sm text-gray-300">显示网格</span>
              </label>
              <label class="flex items-center">
                <input type="checkbox" id="showScale" checked class="rounded mr-2" />
                <span class="text-sm text-gray-300">显示刻度</span>
              </label>
              <label class="flex items-center">
                <input type="checkbox" id="showDefects" checked class="rounded mr-2" />
                <span class="text-sm text-gray-300">标记缺陷</span>
              </label>
            </div>

            <!-- Actions -->
            <div class="space-y-2">
              <button class="btn btn-primary w-full">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                </svg>
                导出图像
              </button>
              <button class="btn btn-secondary w-full">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                生成报告
              </button>
            </div>
          </div>
        </div>

        <!-- Main Display Area -->
        <div class="lg:col-span-3">
          <!-- File Info -->
          <div class="card mb-6">
            <div class="flex items-center justify-between">
              <div>
                <h3 class="text-lg font-bold text-white mb-1">当前文件: 1-焊缝.csv</h3>
                <p class="text-sm text-gray-400">帧数: 50 | 波束数: 7 | 位置点: 896</p>
              </div>
              <div class="flex space-x-2">
                <button class="btn btn-secondary">
                  选择文件
                </button>
              </div>
            </div>
          </div>

          <!-- Main Chart -->
          <div class="card mb-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-bold text-white">超声图像</h3>
              <div class="flex space-x-2">
                <button title="放大" class="p-2 bg-primary-700 rounded hover:bg-primary-600">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v6m3-3H7"></path>
                  </svg>
                </button>
                <button title="缩小" class="p-2 bg-primary-700 rounded hover:bg-primary-600">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM13 10H7"></path>
                  </svg>
                </button>
                <button title="重置" class="p-2 bg-primary-700 rounded hover:bg-primary-600">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                  </svg>
                </button>
                <button title="全屏" class="p-2 bg-primary-700 rounded hover:bg-primary-600">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path>
                  </svg>
                </button>
              </div>
            </div>
            <div id="ultrasonicChart" class="h-[600px] bg-black rounded"></div>
          </div>

          <!-- Statistics -->
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="card">
              <p class="text-sm text-gray-400 mb-1">最大幅值</p>
              <p class="text-2xl font-bold text-white">255</p>
            </div>
            <div class="card">
              <p class="text-sm text-gray-400 mb-1">平均幅值</p>
              <p class="text-2xl font-bold text-white">87.5</p>
            </div>
            <div class="card">
              <p class="text-sm text-gray-400 mb-1">缺陷检出</p>
              <p class="text-2xl font-bold text-warning">15</p>
            </div>
            <div class="card">
              <p class="text-sm text-gray-400 mb-1">质量评级</p>
              <p class="text-2xl font-bold text-success">B级</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
</Layout>

<script>
  import * as echarts from 'echarts';

  // 初始化图表
  const chart = echarts.init(document.getElementById('ultrasonicChart'));
  
  // 生成模拟B-Scan数据
  function generateBScanData() {
    const data = [];
    for (let i = 0; i < 896; i++) {
      for (let j = 0; j < 7; j++) {
        data.push([i, j, Math.floor(Math.random() * 255)]);
      }
    }
    return data;
  }

  // 设置图表选项
  function updateChart() {
    chart.setOption({
      backgroundColor: '#000',
      tooltip: {
        position: 'top',
        formatter: (params: any) => {
          return `位置: ${params.data[0]}<br/>波束: ${params.data[1]}<br/>幅值: ${params.data[2]}`;
        }
      },
      grid: {
        top: 40,
        bottom: 60,
        left: 60,
        right: 40
      },
      xAxis: {
        type: 'category',
        data: Array.from({length: 896}, (_, i) => i + 1),
        name: '位置点',
        nameTextStyle: { color: '#9ca3af' },
        axisLabel: { 
          color: '#9ca3af',
          interval: 99
        }
      },
      yAxis: {
        type: 'category',
        data: Array.from({length: 7}, (_, i) => i + 1),
        name: '波束',
        nameTextStyle: { color: '#9ca3af' },
        axisLabel: { color: '#9ca3af' }
      },
      visualMap: {
        min: 0,
        max: 255,
        calculable: true,
        orient: 'vertical',
        right: 10,
        top: 'center',
        textStyle: { color: '#9ca3af' },
        inRange: {
          color: ['#313695', '#4575b4', '#74add1', '#abd9e9', '#e0f3f8', '#ffffbf', '#fee090', '#fdae61', '#f46d43', '#d73027', '#a50026']
        }
      },
      series: [{
        type: 'heatmap',
        data: generateBScanData(),
        emphasis: {
          itemStyle: {
            shadowBlur: 10,
            shadowColor: 'rgba(0, 0, 0, 0.5)'
          }
        }
      }]
    });
  }

  updateChart();

  // 控制面板事件
  document.getElementById('viewType')?.addEventListener('change', (e) => {
    const value = (e.target as HTMLSelectElement).value;
    console.log('切换显示模式:', value);
    updateChart();
  });

  document.getElementById('contrast')?.addEventListener('input', (e) => {
    const value = (e.target as HTMLInputElement).value;
    document.getElementById('contrastValue')!.textContent = value;
  });

  document.getElementById('brightness')?.addEventListener('input', (e) => {
    const value = (e.target as HTMLInputElement).value;
    document.getElementById('brightnessValue')!.textContent = value;
  });

  document.getElementById('threshold')?.addEventListener('input', (e) => {
    const value = (e.target as HTMLInputElement).value;
    document.getElementById('thresholdValue')!.textContent = value;
  });

  // 响应式
  window.addEventListener('resize', () => {
    chart.resize();
  });
</script>

